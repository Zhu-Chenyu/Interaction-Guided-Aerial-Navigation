<?xml version="1.0"?>
<launch>
  <!-- Offboard test launch file with OptiTrack and RViz visualization -->

  <!-- Parameters for OptiTrack frame names -->
  <arg name="world_frame" default="optitrack" description="OptiTrack world frame"/>
  <arg name="drone_frame" default="imu_link" description="OptiTrack drone rigid body frame"/>
  <arg name="takeoff_height" default="0.15" description="Takeoff height in meters"/>
  <arg name="hover_duration" default="10.0" description="Hover duration in seconds"/>
  <arg name="validation_duration" default="3.0" description="Pose validation duration in seconds"/>
  <arg name="max_position_variance" default="0.01" description="Max allowed position variance during validation"/>

  <!-- Include visualize.launch from drone_viz (OptiTrack, robot state publisher, arena markers, RViz) -->
  <include file="$(find-pkg-share drone_viz)/launch/visualize.launch.xml">
    <arg name="world_frame" value="$(var world_frame)"/>
  </include>

  <!-- Vision bridge: always forwards OptiTrack TF to PX4 VehicleOdometry -->
  <node pkg="offboard_test" exec="vision_bridge_node" name="vision_bridge" output="screen">
    <param name="world_frame" value="$(var world_frame)"/>
    <param name="drone_frame" value="$(var drone_frame)"/>
  </node>

  <!-- Offboard test node (arms, takes off, hovers, lands) - DISABLED, using force_drive_node instead -->
  <!-- <node pkg="offboard_test" exec="offboard_test_node" name="offboard_test" output="screen">
    <param name="world_frame" value="$(var world_frame)"/>
    <param name="drone_frame" value="$(var drone_frame)"/>
    <param name="takeoff_height" value="$(var takeoff_height)"/>
    <param name="hover_duration" value="$(var hover_duration)"/>
    <param name="validation_duration" value="$(var validation_duration)"/>
    <param name="max_position_variance" value="$(var max_position_variance)"/>
  </node> -->

  <!-- Force drive node (drives drone in direction of external force, integrated KF) -->
  <node pkg="offboard_test" exec="force_drive_node" name="force_drive" output="screen">
    <param name="world_frame" value="$(var world_frame)"/>
    <param name="drone_frame" value="$(var drone_frame)"/>
    <param name="takeoff_altitude" value="$(var takeoff_height)"/>
    <param name="altitude_threshold" value="0.05"/>
    <param name="force_deadzone" value="0.5"/>
    <param name="velocity_gain" value="0.5"/>
    <param name="max_velocity" value="1.0"/>
    <param name="decel_rate" value="0.5"/>
    <param name="hold_speed_threshold" value="0.05"/>
    <!-- Obstacle avoidance parameters -->
    <param name="obstacle_avoidance_enabled" value="true"/>
    <param name="repulsion_gain" value="0.1"/>
    <param name="min_obstacle_distance" value="0.15"/>
    <param name="max_obstacle_distance" value="2.0"/>
    <param name="hemicircle_radius_base" value="0.6"/>
    <param name="hemicircle_radius_gain" value="0.2"/>
    <param name="max_repulsion_force" value="3.0"/>
    <param name="scan_downsample_factor" value="4"/>
  </node>

  <!-- Hover position plotter -->
  <!-- <node pkg="offboard_test" exec="plot_hover_position" name="plot_hover_position" output="screen"/> -->

</launch>
